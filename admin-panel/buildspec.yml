version: 0.2

env:
  variables:
    PANEL_DIR: "admin-panel"
    DIST_DIR: "admin-panel/dist/admin-panel"   # where Angular outputs
phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "‚ñ∂ Installing Angular CLI & deps"
      - npm i -g @angular/cli
      - cd $CODEBUILD_SRC_DIR/$PANEL_DIR
      - npm ci --legacy-peer-deps

  pre_build:
    commands:
      - echo "üîé Checking SOURCE for forbidden localhost URLs..."
      - cd $CODEBUILD_SRC_DIR/$PANEL_DIR
      - |
        if grep -R -E "localhost:8000|127\.0\.0\.1:8000" src/; then
          echo "‚ùå Found localhost in SOURCE. Fix before building."; exit 1
        else
          echo "‚úÖ SOURCE clean (no localhost)."
        fi
      - echo "üîé Ensuring you DON'T import environments/environment.prod directly..."
      - |
        if grep -R "environments/environment\.prod" src/; then
          echo "‚ùå Don't import environment.prod directly. Import 'environments/environment'."; exit 1
        else
          echo "‚úÖ No direct environment.prod imports."
        fi

  build:
    commands:
      - echo "üèó Building PRODUCTION bundle..."
      - cd $CODEBUILD_SRC_DIR/$PANEL_DIR
      - ng build --configuration production --output-path=dist/admin-panel

  post_build:
    commands:
      - echo "üîé Verifying BUILT JS has no localhost..."
      - cd $CODEBUILD_SRC_DIR/$DIST_DIR
      - |
        if grep -R -E "localhost:8000|127\.0\.0\.1:8000" ./*.js; then
          echo "‚ùå Built bundle still contains localhost. Fix env/imports or hardcodes."; exit 1
        else
          echo "‚úÖ Built bundle clean."
        fi
      - echo "‚úÖ Build completed on $(date)"

artifacts:
  files:
    - '**/*'
  base-directory: 'admin-panel/dist/admin-panel'
