<div class="container mt-3 px-3">
    <div class="row">
        <div class="col-md-12">
            <!-- Call Status Section -->
            <div *ngIf="callStatus.isActive" class="call-status-section mb-3">
                <div class="call-status" [ngClass]="callStatus.status">
                    <div class="call-info">
                        <i class="fas fa-phone"></i>
                        <span>{{ callStatus.status === 'ringing' ? 'Calling Customer...' : 
                                  callStatus.status === 'connected' ? 'Connected' : 'Call Ended' }}</span>
                    </div>
                    <div class="call-actions">
                        <button 
                            *ngIf="callStatus.status === 'ringing' && callStatus.caller !== 'driver'" 
                            class="btn btn-success btn-sm"
                            (click)="answerCall()">
                            <i class="fas fa-phone"></i> Answer
                        </button>
                        <button 
                            class="btn btn-danger btn-sm"
                            (click)="endCall()">
                            <i class="fas fa-phone-slash"></i> End Call
                        </button>
                    </div>
                </div>
            </div>

            <div class="message-area card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> Customer Communication</h5>
                </div>
                <div class="card-body p-3">
                    <div class="messages" style="height: 400px; overflow-y: auto;">
                        <div *ngIf="isLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading messages...</p>
                        </div>
                        
                        <div *ngIf="!isLoading && messages.length === 0" class="text-center py-4 text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>No messages yet. Start a conversation!</p>
                        </div>
                        
                        <ul class="list-unstyled" *ngIf="!isLoading">
                            <li *ngFor="let message of messages" class="message mb-3" 
                                [ngClass]="{'mine': message.sender_id === currentDriverId, 'theirs': message.sender_id !== currentDriverId}">
                                <div class="bubble">
                                    <div class="message-content">{{ message.content }}</div>
                                    <div class="message-status">
                                        <small class="text-muted">{{ message.created_at | date:'shortTime' }}</small>
                                        <i *ngIf="message.sender_id === currentDriverId" class="fas fa-check-double ms-1" 
                                           [class.text-primary]="true"></i>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="input-group mt-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="Type your message here..." 
                            [(ngModel)]="newMessage" 
                            (keypress)="onKeyPress($event)"
                            [disabled]="!currentUserId">
                        <button 
                            class="btn btn-primary" 
                            (click)="sendMessage()"
                            [disabled]="!newMessage.trim() || !currentUserId">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-12 mt-4">
            <div class="row">
                <div class="col-md-6">
                    <button 
                        class="btn btn-success btn-lg w-100 call-button" 
                        (click)="makeCall()"
                        [disabled]="callStatus.isActive || !currentUserId">
                        <i class="fas fa-phone"></i> Call Customer
                    </button>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info mb-0" *ngIf="!currentUserId">
                        <i class="fas fa-info-circle"></i> 
                        Waiting for customer assignment...
                    </div>
                    <div class="alert alert-success mb-0" *ngIf="currentUserId">
                        <i class="fas fa-user"></i> 
                        Connected to Customer #{{ currentUserId }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Data Section -->
        <div class="col-md-12 mt-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-flask"></i> Testing Tools</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button 
                                class="btn btn-warning btn-sm w-100 mb-2" 
                                (click)="loadTestData()">
                                <i class="fas fa-database"></i> Load Test Messages
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button 
                                class="btn btn-outline-secondary btn-sm w-100 mb-2" 
                                (click)="clearMessages()">
                                <i class="fas fa-trash"></i> Clear Messages
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button 
                                class="btn btn-info btn-sm w-100 mb-2" 
                                (click)="loadTestCallScenario()">
                                <i class="fas fa-phone-alt"></i> Test Call Scenario
                            </button>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted test-info">
                                <i class="fas fa-info-circle"></i> 
                                Use these buttons to test the messaging and calling system.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
