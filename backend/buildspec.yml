version: 0.2

phases:
  install:
    commands:
      - echo "Updating system dependencies..."
      - sudo dnf update -y
      - echo "Installing MySQL Community client..."
      - sudo dnf install -y mysql-community-client --nogpgcheck

  pre_build:
    commands:
      - echo "Fetching environment variables from Parameter Store..."
      - set +x  # Prevent logging sensitive data
      - export DB_HOST=$(aws ssm get-parameter --name "/expressuddb/db_host" --query Parameter.Value --output text)
      - export DB_PORT=$(aws ssm get-parameter --name "/expressuddb/db_port" --query Parameter.Value --output text)
      - export DB_DATABASE=$(aws ssm get-parameter --name "/expressuddb/db_name" --query Parameter.Value --output text)
      - export DB_USERNAME=$(aws ssm get-parameter --name "/expressuddb/db_user" --query Parameter.Value --output text)
      - export DB_PASSWORD=$(aws ssm get-parameter --name "/expressuddb/db_password" --with-decryption --query Parameter.Value --output text)
      - set -x
      - echo "Environment variables loaded successfully."
      - echo "Testing database connectivity..."
      - |
        if mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -e "SHOW DATABASES;"; then
          echo "Successfully connected to the database."
        else
          echo "Failed to connect to the database. Debugging connection..."
          echo "Host: $DB_HOST"
          echo "Port: $DB_PORT"
          echo "Database: $DB_DATABASE"
          echo "Username: $DB_USERNAME"
          exit 1
        fi

  build:
    commands:
      - echo "Building the application..."
      - composer install --no-dev --optimize-autoloader

artifacts:
  files:
    - '**/*'
    - '!node_modules/**/*'
  base-directory: /codebuild/output/src
